# --- S3 Client Setup ---
def get_s3_client():
    """Initializes and returns a boto3 S3 client using credentials from environment variables."""
    try:
        s3_client = boto3.client(
            "s3",
            endpoint_url=os.environ.get("S3_ENDPOINT_URL"),
            aws_access_key_id=os.environ.get("AWS_ACCESS_KEY_ID"),
            aws_secret_access_key=os.environ.get("AWS_SECRET_ACCESS_KEY"),
            region_name=os.environ.get("AWS_REGION"),
        )
        
        ### MODIFIED SECTION ###
        # Get the bucket name from the environment
        bucket_name = os.environ.get("S3_BUCKET_NAME")
        if not bucket_name:
            raise ValueError("S3_BUCKET_NAME environment variable not set.")

        # Verify connection using a more specific and common permission: head_bucket.
        # This checks if the bucket exists and if you have permission to access it.
        s3_client.head_bucket(Bucket=bucket_name)
        logging.info(f"S3 client initialized and connection to bucket '{bucket_name}' verified successfully.")
        return s3_client
        ### END MODIFIED SECTION ###

    except Exception as e:
        logging.error(f"Failed to create or verify S3 client: {e}")
        raise
