Of course. Using Docker Compose is an excellent way to define and run your application in a declarative, reproducible manner. It's a significant improvement over a long docker run command in a shell script.

Here is a complete guide to replacing your run_temp.sh with a docker-compose.yml file.

Step 1: Update Your .env File for Docker Compose

We'll centralize all configuration variables—including paths and GPU info—into your .env file. This makes your docker-compose.yml completely static and reusable.

Replace the contents of your .env file with the following. Remember to fill in your specific values.

.env
code
Ini
download
content_copy
expand_less
# S3 Configuration
S3_ENDPOINT_URL=YOUR_S3_URL_ENDPOINT
AWS_ACCESS_KEY_ID=YOUR_ACCESS_KEY
AWS_SECRET_ACCESS_KEY=YOUR_SECRET_KEY
AWS_REGION=YOUR_BUCKET_REGION

# Docker & Container Configuration
# The name and tag of your Docker image
IMAGE_NAME=finetune_whisper_lora:v3
# The name for the running container
CONTAINER_NAME=lora-finetuning-job-compose
# The specific MIG device UUID to use
MIG_DEVICE_UUID=MIG-GPU-a45fc4b1-c85e-5a3b-8b3d-79191377ec06/4/0

# --- HOST MACHINE PATHS ---
# These paths are on the machine where you run 'docker compose'

# Absolute path to your JSON annotations file
ANNOTATIONS_FILE_PATH=/path/to/your/your_annotations.json
# Absolute path to your CA certificate
S3_CA_BUNDLE_PATH=/path/to/your/ca-bundle.crt

Important: It's best to use absolute paths (e.g., /home/user/project/your_annotations.json) for the file paths in your .env file to avoid any ambiguity when Docker Compose runs.

Step 2: Create the docker-compose.yml File

In the same directory as your .env file, create a new file named docker-compose.yml. This file will define your fine-tuning service, telling Docker exactly how to build and run it.

docker-compose.yml
code
Yaml
download
content_copy
expand_less
version: '3.8'

services:
  finetune-whisper:
    # Use the image name defined in the .env file
    image: ${IMAGE_NAME}
    
    # Set the container name for easy identification
    container_name: ${CONTAINER_NAME}
    
    # Run the container as the current host user to avoid permission issues with mounted files
    # This requires you to run 'export UID=$(id -u) GID=$(id -g)' in your shell before starting
    user: "${UID}:${GID}"
    
    # The command to execute when the container starts
    command: python3 finetune_lora.py
    
    # The working directory inside the container
    working_dir: /app
    
    # Load all variables from the .env file into the container's environment
    env_file: .env
    
    # Set additional environment variables needed by the application
    environment:
      - HF_HOME=/app/.cache/huggingface
      - TORCH_HOME=/app/.cache/torch
      # Tell boto3 (and other tools) where to find the CA certificate inside the container
      - AWS_CA_BUNDLE=/app/ca-bundle.crt
      
    # Define all the volumes to mount from the host into the container
    volumes:
      # Mount the current project directory to /app
      - .:/app
      # Mount a local cache directory to persist downloads
      - ./.cache:/app/.cache
      # Mount the host's passwd and group files to resolve user identity (read-only)
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
      # Mount the annotations file (defined in .env) into the container (read-only)
      - ${ANNOTATIONS_FILE_PATH}:/app/annotations.json:ro
      # Mount the CA certificate (defined in .env) into the container (read-only)
      - ${S3_CA_BUNDLE_PATH}:/app/ca-bundle.crt:ro
      
    # GPU Configuration
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              # Use the device UUID from the .env file
              device_ids: ['${MIG_DEVICE_UUID}']
              capabilities: [gpu]
Step 3: How to Use the New Setup

Your workflow is now much simpler. You no longer need the run_temp.sh script.

1. One-Time User Setup (In your terminal)

Before you run Docker Compose for the first time, you need to export your User ID and Group ID so the container can use them. This ensures that any files created by the container have the correct ownership.

code
Bash
download
content_copy
expand_less
export UID=$(id -u)
export GID=$(id -g)

You only need to do this once per terminal session. You can also add this line to your shell's startup file (like ~/.bashrc or ~/.zshrc) to make it permanent.

2. Start the Fine-Tuning Job

To start the container in the background (detached mode), run:

code
Bash
download
content_copy
expand_less
docker compose up -d

Docker Compose will automatically read your .env file, configure the container, and start the python3 finetune_lora.py command.

3. Monitor the Logs

To see the output of your fine-tuning script in real-time, run:

code
Bash
download
content_copy
expand_less
docker compose logs -f

Press Ctrl+C to stop viewing the logs without stopping the container.

4. Stop and Clean Up

Once your training is complete, or if you want to stop it, run:

code
Bash
download
content_copy
expand_less
docker compose down```
This command gracefully stops and removes the container and any networks created. Your data in the `./.cache` and `./new_whisper_vietbud500_adapter_from_s3` directories will remain since they are on your host machine.

This Docker Compose setup provides a clean, declarative, and industry-standard way to manage your application, making it much easier to run and share your project.
